# This file was automatically generated by weform 0.53.0. Please edit it
# to your liking.

language: generic

env:
  global:
    - TF_VAR_aws_session_name="product-expiry-manager_${TRAVIS_BUILD_NUMBER}"
    - WEFORM_DEPLOY_EMOJI=":alarm_clock:"
    - WEFORM_VERSION="v0.53.0"
    - WORKSPACE_CI=ci-"${TRAVIS_COMMIT:0:8}"
    - SUCCESS_MSG="Successfully deployed version:$TRAVIS_TAG"
    - FAILURE_MSG="Failed to deploy version:$TRAVIS_TAG"

stages:
  - name: deploy to production
    if: tag is present AND tag =~ ^release-
  - name: deploy to staging
    if: tag is present AND tag =~ ^pre-release-
  - name: terraform analyze
    if: (type IN (pull_request))
  - name: docker build
    if: branch = master

jobs:
  include:
    - stage: deploy to production
      install:
        - git clone git@github.com:WeTransfer/weform.git .weform
        - git --git-dir=.weform/.git --work-tree=.weform checkout "$WEFORM_VERSION"
        - source ${TRAVIS_BUILD_DIR}/.weform/scripts/lib/install_deps.sh
        - install_all
      before_script:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/assume_role.sh "arn:aws:iam::724500836836:role/platform" "prod-release-product-expiry-manager" "wetransfer-prod-platform"
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/assume_role.sh "arn:aws:iam::747772944961:role/platform" "prod-release-product-expiry-manager" "wetransfer-plat-platform"
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/generate_kubeconfig.sh --cluster-prefix prod --role platform
        - pushd ${TRAVIS_BUILD_DIR}/terraform && ${TRAVIS_BUILD_DIR}/.weform/scripts/travis.sh init "$TF_VAR_aws_session_name" && popd
      script:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/send_deploy_notification.sh -e prod -r eu-west-1 -u
        - pushd ${TRAVIS_BUILD_DIR}/terraform && ${TRAVIS_BUILD_DIR}/.weform/scripts/travis.sh deploy prod && popd
        - ${TRAVIS_BUILD_DIR}/kubernetes/deploy.sh --profile wetransfer-plat-platform prod --region eu-west-1
      after_failure:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/send_deploy_notification.sh -a fail -e prod -r eu-west-1 -u
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/create_annotation.sh -r eu-west-1 -e prod -s product-expiry-manager -m "$FAILURE_MSG" -k $WEANNOTATE_KEY
      after_success:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/send_deploy_notification.sh -a complete -e prod -r eu-west-1 -u
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/create_annotation.sh -r eu-west-1 -e prod -s product-expiry-manager -m "$SUCCESS_MSG" -k $WEANNOTATE_KEY

    - stage: deploy to staging
      install:
        - git clone git@github.com:WeTransfer/weform.git .weform
        - git --git-dir=.weform/.git --work-tree=.weform checkout "$WEFORM_VERSION"
        - source ${TRAVIS_BUILD_DIR}/.weform/scripts/lib/install_deps.sh
        - install_all
      before_script:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/assume_role.sh "arn:aws:iam::421783656539:role/platform" "stag-release-product-expiry-manager" "wetransfer-stag-platform"
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/assume_role.sh "arn:aws:iam::724500836836:role/platform" "stag-release-product-expiry-manager" "wetransfer-prod-platform"
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/assume_role.sh "arn:aws:iam::747772944961:role/platform" "stag-release-product-expiry-manager" "wetransfer-plat-platform"
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/generate_kubeconfig.sh --cluster-prefix stag --role platform
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/generate_kubeconfig.sh --cluster-prefix prod --role platform
        - pushd ${TRAVIS_BUILD_DIR}/terraform && ${TRAVIS_BUILD_DIR}/.weform/scripts/travis.sh init "$TF_VAR_aws_session_name" && popd
      script:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/send_deploy_notification.sh -e stag -r eu-west-1 -u
        - pushd ${TRAVIS_BUILD_DIR}/terraform && ${TRAVIS_BUILD_DIR}/.weform/scripts/travis.sh deploy stag && popd
        - ${TRAVIS_BUILD_DIR}/kubernetes/deploy.sh --profile wetransfer-plat-platform stag --region eu-west-1
      after_failure:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/send_deploy_notification.sh -a fail -e stag -r eu-west-1 -u
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/create_annotation.sh -r eu-west-1 -e stag -s product-expiry-manager -m "$FAILURE_MSG" -k $WEANNOTATE_KEY
      after_success:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/send_deploy_notification.sh -a complete -e stag -r eu-west-1 -u
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/create_annotation.sh -r eu-west-1 -e stag -s product-expiry-manager -m "$SUCCESS_MSG" -k $WEANNOTATE_KEY

    - stage: terraform analyze
      install:
        - git clone git@github.com:WeTransfer/weform.git .weform
        - git --git-dir=.weform/.git --work-tree=.weform checkout "$WEFORM_VERSION"
        - source ${TRAVIS_BUILD_DIR}/.weform/scripts/lib/install_deps.sh
        - install_terraform
      script:
        - pushd ${TRAVIS_BUILD_DIR}/terraform && ${TRAVIS_BUILD_DIR}/.weform/scripts/travis.sh analyze "$TF_VAR_aws_session_name" && popd

    - stage: docker build
      install:
        - git clone git@github.com:WeTransfer/weform.git .weform
        - git --git-dir=.weform/.git --work-tree=.weform checkout "$WEFORM_VERSION"
        - source ${TRAVIS_BUILD_DIR}/.weform/scripts/lib/install_deps.sh
        - install_aws_cli
      script:
        - ${TRAVIS_BUILD_DIR}/.weform/scripts/docker_push.sh --service product-expiry-manager --tag "$TRAVIS_COMMIT"
